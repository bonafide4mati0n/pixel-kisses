<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Whispers Shrine — DangerousGem + Chat</title>
<style>
  :root{--bg:#0f1724;--card:#111827;--muted:#94a3b8}
  body{margin:0;height:100vh;display:grid;place-items:center;background:#0f1724;font-family:system-ui,Segoe UI,Roboto,Arial;color:#e6eef8}
  .shrine{width:min(860px,94vw);background:#111827;border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,.05)}
  h1{margin:0 0 12px;font-size:22px}
  .buttons{display:flex;flex-wrap:wrap;gap:10px}
  button{background:#1f2937;border:1px solid #2d3748;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:600}
  button:active{transform:translateY(1px)}
  .status{margin-top:16px;font-size:14px;color:var(--muted)}
  .chat-wrap{position:fixed;right:18px;bottom:18px;width:320px;max-height:60vh;background:rgba(4,6,12,0.9);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:10px;overflow:hidden;color:#e6eef8;z-index:9999}
  .chat-head{font-weight:700;margin-bottom:8px}
  .chat-log{height:260px;overflow:auto;padding:6px;background:rgba(255,255,255,0.03);border-radius:6px;margin-bottom:8px}
  .chat-row{display:flex;gap:6px}
  .chat-input{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#e6eef8}
  .chat-send{padding:8px 10px;border-radius:6px;border:none;background:#7c3aed;color:#fff;font-weight:600;cursor:pointer}
  .chat-meta{font-size:12px;color:#94a3b8;margin-top:6px}
  .vc-btn{margin-left:6px;padding:4px 6px;border-radius:6px;border:none;background:#111827;color:#e6eef8;cursor:pointer}
</style>
</head>
<body>
<div class="shrine">
  <h1>Whispers Shrine</h1>
  <div class="buttons">
    <button id="btn-tease">Tease</button>
    <button id="btn-promise">Promise</button>
    <button id="btn-muah">Muah</button>
    <button id="btn-bench">Bench / Reset</button>
    <button id="btn-long">Long Whisper</button>
    <button id="btn-test">Test Hello</button>
  </div>
  <div class="status">Status: <span id="status">idle</span></div>
  <p class="status">Keys: 1=Tease, 2=Promise, 3=Muah, 4=Bench, 5=Long</p>
</div>

<div class="chat-wrap" id="chat">
  <div class="chat-head">Sanctuary Chat</div>
  <div class="chat-log" id="chat-messages"></div>
  <div class="chat-row">
    <input class="chat-input" id="chat-input" placeholder="Say something…" />
    <button class="chat-send" id="chat-send">Send</button>
  </div>
  <div class="chat-meta">Voice/VC:
    <button class="vc-btn" id="vc-join">Join VC</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script type="module">
import { speakAmethyst } from "./lib/voice.js";

/* ===== Voice wiring ===== */
const TEXTS = {tease:"Tease",promise:"Promise",muah:"Muah",bench:"Bench reset",long:"Long whisper"};
const S = (t)=>document.getElementById("status").textContent=t;
async function call(k){const t=TEXTS[k];if(!t)return;S("speaking: "+t);try{await speakAmethyst(t);S("idle")}catch(e){console.error(e);S("error")}}
["tease","promise","muah","bench","long"].forEach(k=>document.getElementById("btn-"+k).onclick=()=>call(k));
window.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT")return;if(e.key==="1")call("tease");if(e.key==="2")call("promise");if(e.key==="3")call("muah");if(e.key==="4")call("bench");if(e.key==="5")call("long")});
document.getElementById("btn-test").onclick=()=>call("tease");

/* ===== Chat wiring ===== */
const myUser = "user-" + Math.random().toString(36).slice(2,6);
const socket = io(`http://${location.hostname}:5501`);
function escapeHtml(s){return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function appendMsg({user="guest",text="",ts=Date.now()}) {
  const w=document.getElementById("chat-messages");
  const el=document.createElement("div");
  el.style.marginBottom="8px";
  el.innerHTML=`<div style="font-size:12px;color:#94a3b8">${escapeHtml(user)} · ${new Date(ts).toLocaleTimeString()}</div><div style="font-size:14px">${escapeHtml(text)}</div>`;
  w.appendChild(el);
  w.scrollTop=w.scrollHeight;
}
socket.on("chat:message",msg=>appendMsg(msg));
document.getElementById("chat-send").onclick=()=>{
  const i=document.getElementById("chat-input");
  const t=i.value.trim(); if(!t)return;
  const m={user:myUser,text:t,ts:Date.now()};
  socket.emit("chat:message",m);
  appendMsg(m);
  i.value="";
};
document.getElementById("chat-input").addEventListener("keydown",e=>{
  if(e.key==="Enter")document.getElementById("chat-send").click()
});
document.getElementById("vc-join").onclick=()=>window.open("https://meet.jit.si/pixel-kisses-"+Math.random().toString(36).slice(2,8),"_blank","noopener");
</script>
</body>
</html>
